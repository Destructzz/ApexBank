# Концепция проекта Apex Account Sharing

## Цель
Общий сервис для хранения игровых аккаунтов и безопасного выдачи доступа друзьям с контролем ролей, аудитом действий и отображением статистики из внешнего API (ApexTracker).

## Основные сценарии
- Владелец заводит аккаунт с деталями, контактами и метаданными игры.
- Делится аккаунтом с конкретным пользователем/группой
- Сервис подтягивает статистику по аккаунту из ApexTracker и хранит ее в бд
- Пользователь видит только доступные ему аккаунты, может просматривать историю и метрики.
- Админ управляет ролями, аудитом и интеграциями (почта, API-ключи и т.д.).

## Архитектура (первичный набросок)
- **Frontend:** Nuxt (SSR/SPA), авторизация через куки/токен, UI для выдачи доступа и просмотра метрик.
- **Backend:** Go (REST). Модули: auth, accounts, grants, roles, stats-sync, audit.
- **БД:** PostgreSQL для основного хранилища;
- **Reverse proxy:** Caddy (TLS, HTTP/2, rate limiting, static, ACME).
- **Развёртывание:** Docker Compose, отдельные сервисы api/web/db/caddy

## Модель данных
- `users` — учетные записи, последние входы.
- `accounts` — платформа, email, пометки, ссылка на создателя - `user`.
- `account_metadata` — ранги, последний сезон, заметки, ссылки на ApexTracker профиль.
- `access_grants` — связи user↔account с ролями/правами (view_stats, use_credentials, manage_shares), срок действия, источник выдачи.
- `roles` — шаблоны прав (admin, user)
- `groups` - группы пользователей создаваемые одним `user`для выдачи прав для других `user`
- `audit_logs` — кто/когда выдал доступ, какие группы создовал



## Интеграции с ApexTracker API
- Использовать fetched_at expires_at с cron логикой по обновлению информации о аккаунтах

## Почта / IMAP (дискуссионно)
## Отложить
- Цель: подтверждения или парсинг уведомлений.
- Подходы: прямой IMAP/POP3 доступ; API провайдера (Gmail/Outlook); webhooks через почтовый шлюз.
- Требования: отдельные сервисные почты, аудит обращений, ретраи и дедупликация писем.

## Безопасность и доступы
- Rate limit middleware для обращения в API
- RBAC + per-account гранты; явные скоупы для действий.
- Шифрование секретов; разграничение доступа к таблицам с секретами и логами.
- Аудит чтения секретов и входов; алерты по подозрительным действиям.

## Типовые потоки
- **Добавление аккаунта:** владелец создаёт запись → привязывает секреты → запускает первичную синхронизацию → выдаёт роли.
- **Выдача доступа другу:** admin/manager создаёт grant с ролью и TTL → логируется действие → уведомление пользователю.
- **Синк статистики:** worker по расписанию тянет данные → кеширует → обновляет историю → метрики доступны в UI.
- **Просмотр:** пользователь логинится → получает список доступных аккаунтов с ролью → видит актуальные статы/историю.

## Docker Compose (набросок сервисов)
- `caddy` — reverse proxy, TLS/HTTP/2, маршрутизация на web/api.
- `api` — Go backend, env для ключей ApexTracker, подключение к PG/Redis.
- `web` — Nuxt, собирается и сервируется через Caddy или самостоятельный node контейнер.
- `db` — PostgreSQL с volume, init миграции (sqlc/atlas/migrate).
- `worker` — Go worker/cron для sync и почтовых задач.

## Открытые вопросы / next steps
- Уточнить формат ролей и грантов (тонкие пермишены или скоупы по типам действий).

    У каждого юзера будет возможность добавить в доступ к совему аккаунту другому юзру по нику или по группе (в группе несколько человек). группу может создать как сам юзер как и взять общие группы созданные другим человеком.

- Выбрать механизм хранения секретов.

    api будет храниться в .env все остальные данные в бд без шифрования

- Решить стратегию для почты (IMAP vs API провайдеров) и кейсы использования.

    отложено

- Специфицировать публичные/внутренние API, схемы авторизации (JWT/сессионные куки).

    вход по самописному Oauth на google и хранение токена в cookie

- Проработать лимиты ApexTracker и политику обновлений (частота, батчи, приоритеты).

    сделать логику по жескому рейтлимиту api от tracker. сделать cron задачи выполняемые по таймеру и своей очереди. все доступы к api идут только через логику очередей

- Наметить минимальный UI-флоу: добавление аккаунта, выдача доступа, просмотр статистики.

    будет страница профиля, в котором будет статистика сколько аккаунтов есть сколько доступны (вне своих) будет свой цвет рамки (RGB)

    аккаунты будут как карточки с доступом будет показываться owner ранг, уровень и рамка карточки под цвет owner.

    будет окно для добавления группы юзеров

